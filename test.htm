<html>
    <script>
        var state = 0;
        var state2 = 0;
        
        function secondStateMachine(fn) {
            switch(state2){
                case 0: 
                    console.log("1st hit, 2nd machine");
                    break;
                case 1:
                    console.log("2nd hit, 2nd machine");
                    break;
                case 2:
                    console.log("3rd hit, 2nd machine");
                    break;
                case 3:
                    fn();
                    return;
            }
            secondSwitchState(fn);
        }

        function stateMachine(){
            switch(state){
                case -1:
                    if(state2 == 3) {
                        state = 0;
                    }
                    break;
                case 0: 
                    console.log("first state");
                    state = -1;
                    secondStateMachine(completeFn);
                    break;
                case 1: 
                    console.log("second state");
                    break;
                case 2: 
                    console.log("third state");
                    break;
                case 3:
                    console.log("first state machine completed");
                    return;
            }
            switchState();
        }

        function secondSwitchState(completeFn) {
            state2++;
            setTimeout( () => secondStateMachine(completeFn), 1000);
        }

        function switchState(){
            if(state != -1) {
                state++;
            }
            setTimeout( () => stateMachine(), 1000) ;
        }

        function completeFn(){
            console.log("2nd machine completed");
        }

        stateMachine();
    </script>
</html>